/**
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */'use strict';var cov_pcqkr03i0=function(){var path='/Users/gurleenk/athenz_repo_new/athenz/libs/nodejs/auth_core/src/impl/RoleAuthority.js',hash='08ae25b392d5303176600bda118f85aab9df528f',Function=function(){}.constructor,global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/gurleenk/athenz_repo_new/athenz/libs/nodejs/auth_core/src/impl/RoleAuthority.js',statementMap:{'0':{start:{line:16,column:14},end:{line:16,column:32}},'1':{start:{line:17,column:16},end:{line:17,column:45}},'2':{start:{line:18,column:22},end:{line:18,column:50}},'3':{start:{line:19,column:13},end:{line:19,column:45}},'4':{start:{line:21,column:18},end:{line:21,column:24}},'5':{start:{line:22,column:22},end:{line:22,column:32}},'6':{start:{line:23,column:18},end:{line:23,column:23}},'7':{start:{line:31,column:4},end:{line:31,column:36}},'8':{start:{line:33,column:4},end:{line:33,column:69}},'9':{start:{line:34,column:4},end:{line:34,column:52}},'10':{start:{line:35,column:4},end:{line:35,column:48}},'11':{start:{line:37,column:4},end:{line:37,column:26}},'12':{start:{line:38,column:4},end:{line:38,column:94}},'13':{start:{line:39,column:4},end:{line:39,column:57}},'14':{start:{line:40,column:4},end:{line:40,column:69}},'15':{start:{line:43,column:4},end:{line:45,column:5}},'16':{start:{line:44,column:6},end:{line:44,column:32}},'17':{start:{line:49,column:4},end:{line:49,column:52}},'18':{start:{line:50,column:4},end:{line:50,column:27}},'19':{start:{line:51,column:4},end:{line:51,column:33}},'20':{start:{line:58,column:4},end:{line:58,column:22}},'21':{start:{line:62,column:4},end:{line:62,column:28}},'22':{start:{line:66,column:4},end:{line:66,column:67}},'23':{start:{line:68,column:20},end:{line:68,column:24}},'24':{start:{line:69,column:4},end:{line:75,column:5}},'25':{start:{line:70,column:6},end:{line:70,column:45}},'26':{start:{line:72,column:6},end:{line:73,column:68}},'27':{start:{line:74,column:6},end:{line:74,column:18}},'28':{start:{line:81,column:4},end:{line:99,column:5}},'29':{start:{line:82,column:27},end:{line:82,column:51}},'30':{start:{line:83,column:16},end:{line:83,column:47}},'31':{start:{line:85,column:6},end:{line:90,column:7}},'32':{start:{line:86,column:8},end:{line:88,column:51}},'33':{start:{line:89,column:8},end:{line:89,column:20}},'34':{start:{line:92,column:6},end:{line:98,column:7}},'35':{start:{line:93,column:8},end:{line:96,column:51}},'36':{start:{line:97,column:8},end:{line:97,column:20}},'37':{start:{line:101,column:20},end:{line:101,column:99}},'38':{start:{line:103,column:4},end:{line:107,column:5}},'39':{start:{line:104,column:6},end:{line:105,column:49}},'40':{start:{line:106,column:6},end:{line:106,column:18}},'41':{start:{line:112,column:16},end:{line:112,column:109}},'42':{start:{line:113,column:4},end:{line:113,column:57}},'43':{start:{line:114,column:4},end:{line:114,column:17}},'44':{start:{line:118,column:4},end:{line:120,column:5}},'45':{start:{line:119,column:6},end:{line:119,column:19}},'46':{start:{line:121,column:4},end:{line:125,column:5}},'47':{start:{line:122,column:6},end:{line:122,column:18}},'48':{start:{line:124,column:6},end:{line:124,column:19}},'49':{start:{line:129,column:4},end:{line:129,column:30}},'50':{start:{line:133,column:0},end:{line:133,column:31}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:30,column:2},end:{line:30,column:3}},loc:{start:{line:30,column:16},end:{line:46,column:3}},line:30},'1':{name:'(anonymous_1)',decl:{start:{line:48,column:2},end:{line:48,column:3}},loc:{start:{line:48,column:22},end:{line:52,column:3}},line:48},'2':{name:'(anonymous_2)',decl:{start:{line:54,column:2},end:{line:54,column:3}},loc:{start:{line:54,column:15},end:{line:55,column:3}},line:54},'3':{name:'(anonymous_3)',decl:{start:{line:57,column:2},end:{line:57,column:3}},loc:{start:{line:57,column:14},end:{line:59,column:3}},line:57},'4':{name:'(anonymous_4)',decl:{start:{line:61,column:2},end:{line:61,column:3}},loc:{start:{line:61,column:14},end:{line:63,column:3}},line:61},'5':{name:'(anonymous_5)',decl:{start:{line:65,column:2},end:{line:65,column:3}},loc:{start:{line:65,column:52},end:{line:115,column:3}},line:65},'6':{name:'(anonymous_6)',decl:{start:{line:117,column:2},end:{line:117,column:3}},loc:{start:{line:117,column:32},end:{line:126,column:3}},line:117},'7':{name:'(anonymous_7)',decl:{start:{line:128,column:2},end:{line:128,column:3}},loc:{start:{line:128,column:24},end:{line:130,column:3}},line:128}},branchMap:{'0':{loc:{start:{line:38,column:26},end:{line:38,column:93}},type:'cond-expr',locations:[{start:{line:38,column:55},end:{line:38,column:87}},{start:{line:38,column:90},end:{line:38,column:93}}],line:38},'1':{loc:{start:{line:39,column:23},end:{line:39,column:56}},type:'binary-expr',locations:[{start:{line:39,column:23},end:{line:39,column:46}},{start:{line:39,column:50},end:{line:39,column:56}}],line:39},'2':{loc:{start:{line:40,column:23},end:{line:40,column:68}},type:'binary-expr',locations:[{start:{line:40,column:23},end:{line:40,column:46}},{start:{line:40,column:50},end:{line:40,column:68}}],line:40},'3':{loc:{start:{line:43,column:4},end:{line:45,column:5}},type:'if',locations:[{start:{line:43,column:4},end:{line:45,column:5}},{start:{line:43,column:4},end:{line:45,column:5}}],line:43},'4':{loc:{start:{line:81,column:4},end:{line:99,column:5}},type:'if',locations:[{start:{line:81,column:4},end:{line:99,column:5}},{start:{line:81,column:4},end:{line:99,column:5}}],line:81},'5':{loc:{start:{line:81,column:8},end:{line:81,column:78}},type:'binary-expr',locations:[{start:{line:81,column:8},end:{line:81,column:40}},{start:{line:81,column:44},end:{line:81,column:78}}],line:81},'6':{loc:{start:{line:85,column:6},end:{line:90,column:7}},type:'if',locations:[{start:{line:85,column:6},end:{line:90,column:7}},{start:{line:85,column:6},end:{line:90,column:7}}],line:85},'7':{loc:{start:{line:85,column:10},end:{line:85,column:55}},type:'binary-expr',locations:[{start:{line:85,column:10},end:{line:85,column:18}},{start:{line:85,column:22},end:{line:85,column:55}}],line:85},'8':{loc:{start:{line:92,column:6},end:{line:98,column:7}},type:'if',locations:[{start:{line:92,column:6},end:{line:98,column:7}},{start:{line:92,column:6},end:{line:98,column:7}}],line:92},'9':{loc:{start:{line:103,column:4},end:{line:107,column:5}},type:'if',locations:[{start:{line:103,column:4},end:{line:107,column:5}},{start:{line:103,column:4},end:{line:107,column:5}}],line:103},'10':{loc:{start:{line:118,column:4},end:{line:120,column:5}},type:'if',locations:[{start:{line:118,column:4},end:{line:120,column:5}},{start:{line:118,column:4},end:{line:120,column:5}}],line:118},'11':{loc:{start:{line:121,column:4},end:{line:125,column:5}},type:'if',locations:[{start:{line:121,column:4},end:{line:125,column:5}},{start:{line:121,column:4},end:{line:125,column:5}}],line:121},'12':{loc:{start:{line:121,column:8},end:{line:121,column:155}},type:'binary-expr',locations:[{start:{line:121,column:8},end:{line:121,column:53}},{start:{line:121,column:57},end:{line:121,column:103}},{start:{line:121,column:107},end:{line:121,column:155}}],line:121}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0],'9':[0,0],'10':[0,0],'11':[0,0],'12':[0,0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var winston=(cov_pcqkr03i0.s[0]++,require('winston'));var RoleToken=(cov_pcqkr03i0.s[1]++,require('../token/RoleToken'));var SimplePrincipal=(cov_pcqkr03i0.s[2]++,require('./SimplePrincipal'));var config=(cov_pcqkr03i0.s[3]++,require('../../config/config')());var USER_DOMAIN=(cov_pcqkr03i0.s[4]++,'user');var SYS_AUTH_DOMAIN=(cov_pcqkr03i0.s[5]++,'sys.auth');var ZTS_SERVICE=(cov_pcqkr03i0.s[6]++,'zts');var ATHENZ_PROP_TOKEN_OFFSET;var ATHENZ_PROP_USER_DOMAIN;var ATHENZ_PROP_ROLE_HEADER;class RoleAuthority{constructor(){cov_pcqkr03i0.f[0]++;cov_pcqkr03i0.s[7]++;winston.level=config.logLevel;cov_pcqkr03i0.s[8]++;ATHENZ_PROP_TOKEN_OFFSET=Number(config.roleTokenAllowedOffset);cov_pcqkr03i0.s[9]++;ATHENZ_PROP_USER_DOMAIN=config.roleUserDomain;cov_pcqkr03i0.s[10]++;ATHENZ_PROP_ROLE_HEADER=config.roleHeader;cov_pcqkr03i0.s[11]++;this._keyStore=null;cov_pcqkr03i0.s[12]++;this._allowedOffset=ATHENZ_PROP_TOKEN_OFFSET?(cov_pcqkr03i0.b[0][0]++,Number(ATHENZ_PROP_TOKEN_OFFSET)):(cov_pcqkr03i0.b[0][1]++,300);cov_pcqkr03i0.s[13]++;this._userDomain=(cov_pcqkr03i0.b[1][0]++,ATHENZ_PROP_USER_DOMAIN)||(cov_pcqkr03i0.b[1][1]++,'user');cov_pcqkr03i0.s[14]++;this._headerName=(cov_pcqkr03i0.b[2][0]++,ATHENZ_PROP_ROLE_HEADER)||(cov_pcqkr03i0.b[2][1]++,'Athenz-Role-Auth');// case of invalid value, we'll default back to 5 minutes
cov_pcqkr03i0.s[15]++;if(this._allowedOffset<0){cov_pcqkr03i0.b[3][0]++;cov_pcqkr03i0.s[16]++;this._allowedOffset=300;}else{cov_pcqkr03i0.b[3][1]++;}}static setConfig(c){cov_pcqkr03i0.f[1]++;cov_pcqkr03i0.s[17]++;config=Object.assign({},config,c.auth_core);cov_pcqkr03i0.s[18]++;RoleToken.setConfig(c);cov_pcqkr03i0.s[19]++;SimplePrincipal.setConfig(c);}initialize(){cov_pcqkr03i0.f[2]++;}getDomain(){cov_pcqkr03i0.f[3]++;cov_pcqkr03i0.s[20]++;return'sys.auth';}getHeader(){cov_pcqkr03i0.f[4]++;cov_pcqkr03i0.s[21]++;return this._headerName;}authenticate(signedToken,remoteAddr,httpMethod){cov_pcqkr03i0.f[5]++;cov_pcqkr03i0.s[22]++;winston.debug('Authenticating PrincipalToken: '+signedToken);var roleToken=(cov_pcqkr03i0.s[23]++,null);cov_pcqkr03i0.s[24]++;try{cov_pcqkr03i0.s[25]++;roleToken=new RoleToken(signedToken);}catch(e){cov_pcqkr03i0.s[26]++;winston.error('PrincipalAuthority:authenticate: Invalid token: exc='+e.message+' : credential='+RoleToken.getUnsignedToken(signedToken));cov_pcqkr03i0.s[27]++;return null;}/* if the token's domain is user then we need to check to see if this is a write
     * operation (PUT/POST/DELETE) and in that case we must validate the IP
     * address of the incoming request to make sure it matches to IP address
     * that's stored in the RoleToken */cov_pcqkr03i0.s[28]++;if((cov_pcqkr03i0.b[5][0]++,remoteAddr!==roleToken.getIP())&&(cov_pcqkr03i0.b[5][1]++,this._isWriteOperation(httpMethod))){cov_pcqkr03i0.b[4][0]++;var tokenPrincipal=(cov_pcqkr03i0.s[29]++,roleToken.getPrincipal());var idx=(cov_pcqkr03i0.s[30]++,tokenPrincipal.lastIndexOf('.'));cov_pcqkr03i0.s[31]++;if((cov_pcqkr03i0.b[7][0]++,idx<=0)||(cov_pcqkr03i0.b[7][1]++,idx===tokenPrincipal.length-1)){cov_pcqkr03i0.b[6][0]++;cov_pcqkr03i0.s[32]++;winston.error('RoleAuthority:authenticate failed: Invalid principal specified: '+tokenPrincipal+': credential='+RoleToken.getUnsignedToken(signedToken));cov_pcqkr03i0.s[33]++;return null;}else{cov_pcqkr03i0.b[6][1]++;}cov_pcqkr03i0.s[34]++;if(tokenPrincipal.substring(0,idx).toLowerCase()===this._userDomain){cov_pcqkr03i0.b[8][0]++;cov_pcqkr03i0.s[35]++;winston.error('RoleAuthority:authenticate failed: IP Mismatch - tokenip('+roleToken.getIP()+') request-addr('+remoteAddr+') credential='+RoleToken.getUnsignedToken(signedToken));cov_pcqkr03i0.s[36]++;return null;}else{cov_pcqkr03i0.b[8][1]++;}}else{cov_pcqkr03i0.b[4][1]++;}var publicKey=(cov_pcqkr03i0.s[37]++,this._keyStore.getPublicKey(SYS_AUTH_DOMAIN,ZTS_SERVICE,roleToken.getKeyId()));cov_pcqkr03i0.s[38]++;if(roleToken.validate(publicKey,this._allowedOffset,false)===false){cov_pcqkr03i0.b[9][0]++;cov_pcqkr03i0.s[39]++;winston.error('RoleAuthority:authenticate failed: validation was not successful: credential='+RoleToken.getUnsignedToken(signedToken));cov_pcqkr03i0.s[40]++;return null;}else{cov_pcqkr03i0.b[9][1]++;}// all the role members in Athenz are normalized to lower case so we need to make
// sure our principal's name and domain are created with lower case as well
var princ=(cov_pcqkr03i0.s[41]++,SimplePrincipal.createByRoles(roleToken.getDomain(),signedToken,roleToken.getRoles(),this));cov_pcqkr03i0.s[42]++;princ.setUnsignedCreds(roleToken.getUnsignedToken());cov_pcqkr03i0.s[43]++;return princ;}_isWriteOperation(httpMethod){cov_pcqkr03i0.f[6]++;cov_pcqkr03i0.s[44]++;if(!httpMethod){cov_pcqkr03i0.b[10][0]++;cov_pcqkr03i0.s[45]++;return false;}else{cov_pcqkr03i0.b[10][1]++;}cov_pcqkr03i0.s[46]++;if((cov_pcqkr03i0.b[12][0]++,httpMethod.toString().toUpperCase()==='PUT')||(cov_pcqkr03i0.b[12][1]++,httpMethod.toString().toUpperCase()==='POST')||(cov_pcqkr03i0.b[12][2]++,httpMethod.toString().toUpperCase()==='DELETE')){cov_pcqkr03i0.b[11][0]++;cov_pcqkr03i0.s[47]++;return true;}else{cov_pcqkr03i0.b[11][1]++;cov_pcqkr03i0.s[48]++;return false;}}setKeyStore(keyStore){cov_pcqkr03i0.f[7]++;cov_pcqkr03i0.s[49]++;this._keyStore=keyStore;}}cov_pcqkr03i0.s[50]++;module.exports=RoleAuthority;