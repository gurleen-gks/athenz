/**
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */'use strict';var cov_2a4g80rn2i=function(){var path='/Users/gurleenk/athenz_repo_new/athenz/libs/nodejs/auth_core/src/token/Token.js',hash='dcca07cadfe6abf0bbd1a8923755239dbfb5feb7',Function=function(){}.constructor,global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/gurleenk/athenz_repo_new/athenz/libs/nodejs/auth_core/src/token/Token.js',statementMap:{'0':{start:{line:16,column:14},end:{line:16,column:32}},'1':{start:{line:17,column:13},end:{line:17,column:38}},'2':{start:{line:18,column:13},end:{line:18,column:45}},'3':{start:{line:25,column:4},end:{line:25,column:36}},'4':{start:{line:27,column:4},end:{line:27,column:134}},'5':{start:{line:28,column:4},end:{line:28,column:50}},'6':{start:{line:30,column:4},end:{line:30,column:31}},'7':{start:{line:31,column:4},end:{line:31,column:29}},'8':{start:{line:32,column:4},end:{line:32,column:25}},'9':{start:{line:33,column:4},end:{line:33,column:22}},'10':{start:{line:34,column:4},end:{line:34,column:22}},'11':{start:{line:35,column:4},end:{line:35,column:20}},'12':{start:{line:36,column:4},end:{line:36,column:24}},'13':{start:{line:37,column:4},end:{line:37,column:27}},'14':{start:{line:38,column:4},end:{line:38,column:22}},'15':{start:{line:39,column:4},end:{line:39,column:25}},'16':{start:{line:40,column:4},end:{line:40,column:24}},'17':{start:{line:41,column:4},end:{line:41,column:37}},'18':{start:{line:45,column:4},end:{line:45,column:52}},'19':{start:{line:49,column:4},end:{line:54,column:5}},'20':{start:{line:50,column:6},end:{line:50,column:92}},'21':{start:{line:51,column:6},end:{line:51,column:72}},'22':{start:{line:53,column:6},end:{line:53,column:14}},'23':{start:{line:58,column:4},end:{line:58,column:82}},'24':{start:{line:59,column:4},end:{line:59,column:58}},'25':{start:{line:64,column:14},end:{line:64,column:18}},'26':{start:{line:65,column:4},end:{line:70,column:5}},'27':{start:{line:66,column:6},end:{line:67,column:47}},'28':{start:{line:68,column:6},end:{line:68,column:25}},'29':{start:{line:69,column:6},end:{line:69,column:19}},'30':{start:{line:72,column:4},end:{line:77,column:5}},'31':{start:{line:73,column:6},end:{line:74,column:37}},'32':{start:{line:75,column:6},end:{line:75,column:25}},'33':{start:{line:76,column:6},end:{line:76,column:19}},'34':{start:{line:79,column:14},end:{line:79,column:43}},'35':{start:{line:83,column:4},end:{line:90,column:5}},'36':{start:{line:84,column:6},end:{line:87,column:46}},'37':{start:{line:88,column:6},end:{line:88,column:25}},'38':{start:{line:89,column:6},end:{line:89,column:19}},'39':{start:{line:95,column:4},end:{line:112,column:5}},'40':{start:{line:96,column:6},end:{line:102,column:7}},'41':{start:{line:97,column:8},end:{line:99,column:36}},'42':{start:{line:100,column:8},end:{line:100,column:27}},'43':{start:{line:101,column:8},end:{line:101,column:21}},'44':{start:{line:103,column:6},end:{line:111,column:7}},'45':{start:{line:104,column:8},end:{line:108,column:48}},'46':{start:{line:109,column:8},end:{line:109,column:27}},'47':{start:{line:110,column:8},end:{line:110,column:21}},'48':{start:{line:114,column:19},end:{line:114,column:24}},'49':{start:{line:115,column:4},end:{line:127,column:5}},'50':{start:{line:116,column:6},end:{line:116,column:103}},'51':{start:{line:117,column:6},end:{line:123,column:7}},'52':{start:{line:118,column:8},end:{line:119,column:38}},'53':{start:{line:120,column:8},end:{line:120,column:27}},'54':{start:{line:122,column:8},end:{line:122,column:68}},'55':{start:{line:125,column:6},end:{line:126,column:68}},'56':{start:{line:129,column:4},end:{line:129,column:20}},'57':{start:{line:133,column:4},end:{line:133,column:25}},'58':{start:{line:137,column:4},end:{line:137,column:22}},'59':{start:{line:141,column:4},end:{line:141,column:22}},'60':{start:{line:145,column:4},end:{line:145,column:24}},'61':{start:{line:149,column:4},end:{line:149,column:27}},'62':{start:{line:153,column:4},end:{line:153,column:27}},'63':{start:{line:157,column:4},end:{line:157,column:28}},'64':{start:{line:161,column:4},end:{line:161,column:29}},'65':{start:{line:165,column:4},end:{line:165,column:23}},'66':{start:{line:169,column:4},end:{line:169,column:20}},'67':{start:{line:173,column:4},end:{line:173,column:31}},'68':{start:{line:183,column:4},end:{line:188,column:5}},'69':{start:{line:184,column:16},end:{line:184,column:41}},'70':{start:{line:185,column:6},end:{line:187,column:7}},'71':{start:{line:186,column:8},end:{line:186,column:50}},'72':{start:{line:190,column:4},end:{line:190,column:22}},'73':{start:{line:194,column:0},end:{line:194,column:23}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:24,column:2},end:{line:24,column:3}},loc:{start:{line:24,column:16},end:{line:42,column:3}},line:24},'1':{name:'(anonymous_1)',decl:{start:{line:44,column:2},end:{line:44,column:3}},loc:{start:{line:44,column:22},end:{line:46,column:3}},line:44},'2':{name:'(anonymous_2)',decl:{start:{line:48,column:2},end:{line:48,column:3}},loc:{start:{line:48,column:19},end:{line:55,column:3}},line:48},'3':{name:'(anonymous_3)',decl:{start:{line:57,column:2},end:{line:57,column:3}},loc:{start:{line:57,column:44},end:{line:60,column:3}},line:57},'4':{name:'(anonymous_4)',decl:{start:{line:63,column:2},end:{line:63,column:3}},loc:{start:{line:63,column:52},end:{line:130,column:3}},line:63},'5':{name:'(anonymous_5)',decl:{start:{line:132,column:2},end:{line:132,column:3}},loc:{start:{line:132,column:15},end:{line:134,column:3}},line:132},'6':{name:'(anonymous_6)',decl:{start:{line:136,column:2},end:{line:136,column:3}},loc:{start:{line:136,column:12},end:{line:138,column:3}},line:136},'7':{name:'(anonymous_7)',decl:{start:{line:140,column:2},end:{line:140,column:3}},loc:{start:{line:140,column:12},end:{line:142,column:3}},line:140},'8':{name:'(anonymous_8)',decl:{start:{line:144,column:2},end:{line:144,column:3}},loc:{start:{line:144,column:14},end:{line:146,column:3}},line:144},'9':{name:'(anonymous_9)',decl:{start:{line:148,column:2},end:{line:148,column:3}},loc:{start:{line:148,column:17},end:{line:150,column:3}},line:148},'10':{name:'(anonymous_10)',decl:{start:{line:152,column:2},end:{line:152,column:3}},loc:{start:{line:152,column:17},end:{line:154,column:3}},line:152},'11':{name:'(anonymous_11)',decl:{start:{line:156,column:2},end:{line:156,column:3}},loc:{start:{line:156,column:18},end:{line:158,column:3}},line:156},'12':{name:'(anonymous_12)',decl:{start:{line:160,column:2},end:{line:160,column:3}},loc:{start:{line:160,column:19},end:{line:162,column:3}},line:160},'13':{name:'(anonymous_13)',decl:{start:{line:164,column:2},end:{line:164,column:3}},loc:{start:{line:164,column:13},end:{line:166,column:3}},line:164},'14':{name:'(anonymous_14)',decl:{start:{line:168,column:2},end:{line:168,column:3}},loc:{start:{line:168,column:10},end:{line:170,column:3}},line:168},'15':{name:'(anonymous_15)',decl:{start:{line:172,column:2},end:{line:172,column:3}},loc:{start:{line:172,column:21},end:{line:174,column:3}},line:172},'16':{name:'(anonymous_16)',decl:{start:{line:182,column:2},end:{line:182,column:3}},loc:{start:{line:182,column:38},end:{line:191,column:3}},line:182}},branchMap:{'0':{loc:{start:{line:27,column:30},end:{line:27,column:133}},type:'cond-expr',locations:[{start:{line:27,column:84},end:{line:27,column:101}},{start:{line:27,column:104},end:{line:27,column:133}}],line:27},'1':{loc:{start:{line:58,column:22},end:{line:58,column:81}},type:'cond-expr',locations:[{start:{line:58,column:40},end:{line:58,column:49}},{start:{line:58,column:52},end:{line:58,column:81}}],line:58},'2':{loc:{start:{line:65,column:4},end:{line:70,column:5}},type:'if',locations:[{start:{line:65,column:4},end:{line:70,column:5}},{start:{line:65,column:4},end:{line:70,column:5}}],line:65},'3':{loc:{start:{line:65,column:8},end:{line:65,column:48}},type:'binary-expr',locations:[{start:{line:65,column:8},end:{line:65,column:28}},{start:{line:65,column:32},end:{line:65,column:48}}],line:65},'4':{loc:{start:{line:72,column:4},end:{line:77,column:5}},type:'if',locations:[{start:{line:72,column:4},end:{line:77,column:5}},{start:{line:72,column:4},end:{line:77,column:5}}],line:72},'5':{loc:{start:{line:83,column:4},end:{line:90,column:5}},type:'if',locations:[{start:{line:83,column:4},end:{line:90,column:5}},{start:{line:83,column:4},end:{line:90,column:5}}],line:83},'6':{loc:{start:{line:83,column:8},end:{line:83,column:70}},type:'binary-expr',locations:[{start:{line:83,column:8},end:{line:83,column:29}},{start:{line:83,column:33},end:{line:83,column:70}}],line:83},'7':{loc:{start:{line:95,column:4},end:{line:112,column:5}},type:'if',locations:[{start:{line:95,column:4},end:{line:112,column:5}},{start:{line:95,column:4},end:{line:112,column:5}}],line:95},'8':{loc:{start:{line:95,column:8},end:{line:95,column:75}},type:'binary-expr',locations:[{start:{line:95,column:8},end:{line:95,column:30}},{start:{line:95,column:34},end:{line:95,column:57}},{start:{line:95,column:61},end:{line:95,column:75}}],line:95},'9':{loc:{start:{line:96,column:6},end:{line:102,column:7}},type:'if',locations:[{start:{line:96,column:6},end:{line:102,column:7}},{start:{line:96,column:6},end:{line:102,column:7}}],line:96},'10':{loc:{start:{line:103,column:6},end:{line:111,column:7}},type:'if',locations:[{start:{line:103,column:6},end:{line:111,column:7}},{start:{line:103,column:6},end:{line:111,column:7}}],line:103},'11':{loc:{start:{line:117,column:6},end:{line:123,column:7}},type:'if',locations:[{start:{line:117,column:6},end:{line:123,column:7}},{start:{line:117,column:6},end:{line:123,column:7}}],line:117},'12':{loc:{start:{line:183,column:4},end:{line:188,column:5}},type:'if',locations:[{start:{line:183,column:4},end:{line:188,column:5}},{start:{line:183,column:4},end:{line:188,column:5}}],line:183},'13':{loc:{start:{line:185,column:6},end:{line:187,column:7}},type:'if',locations:[{start:{line:185,column:6},end:{line:187,column:7}},{start:{line:185,column:6},end:{line:187,column:7}}],line:185}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0,'58':0,'59':0,'60':0,'61':0,'62':0,'63':0,'64':0,'65':0,'66':0,'67':0,'68':0,'69':0,'70':0,'71':0,'72':0,'73':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0,0],'9':[0,0],'10':[0,0],'11':[0,0],'12':[0,0],'13':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var winston=(cov_2a4g80rn2i.s[0]++,require('winston'));var Crypto=(cov_2a4g80rn2i.s[1]++,require('../util/Crypto'));var config=(cov_2a4g80rn2i.s[2]++,require('../../config/config')());var ATHENZ_TOKEN_MAX_EXPIRY;var ATHENZ_TOKEN_NO_EXPIRY;class Token{constructor(){cov_2a4g80rn2i.f[0]++;cov_2a4g80rn2i.s[3]++;winston.level=config.logLevel;cov_2a4g80rn2i.s[4]++;ATHENZ_TOKEN_MAX_EXPIRY=Number(config.tokenMaxExpiry)>30*24*60*60?(cov_2a4g80rn2i.b[0][0]++,30*24*60*60):(cov_2a4g80rn2i.b[0][1]++,Number(config.tokenMaxExpiry));cov_2a4g80rn2i.s[5]++;ATHENZ_TOKEN_NO_EXPIRY=config.tokenNoExpiry;cov_2a4g80rn2i.s[6]++;this._unsignedToken=null;cov_2a4g80rn2i.s[7]++;this._signedToken=null;cov_2a4g80rn2i.s[8]++;this._version=null;cov_2a4g80rn2i.s[9]++;this._salt=null;cov_2a4g80rn2i.s[10]++;this._host=null;cov_2a4g80rn2i.s[11]++;this._ip=null;cov_2a4g80rn2i.s[12]++;this._domain=null;cov_2a4g80rn2i.s[13]++;this._signature=null;cov_2a4g80rn2i.s[14]++;this._keyId='0';cov_2a4g80rn2i.s[15]++;this._expiryTime=0;cov_2a4g80rn2i.s[16]++;this._timestamp=0;cov_2a4g80rn2i.s[17]++;this._digestAlgorithm='SHA256';}static setConfig(c){cov_2a4g80rn2i.f[1]++;cov_2a4g80rn2i.s[18]++;config=Object.assign({},config,c.auth_core);}sign(privateKey){cov_2a4g80rn2i.f[2]++;cov_2a4g80rn2i.s[19]++;try{cov_2a4g80rn2i.s[20]++;this._signature=Crypto.sign(this._unsignedToken,privateKey,this._digestAlgorithm);cov_2a4g80rn2i.s[21]++;this._signedToken=this._unsignedToken+';s='+this._signature;}catch(e){cov_2a4g80rn2i.s[22]++;throw e;}}setTimeStamp(issueTime,expirationWindow){cov_2a4g80rn2i.f[3]++;cov_2a4g80rn2i.s[23]++;this._timestamp=issueTime>0?(cov_2a4g80rn2i.b[1][0]++,issueTime):(cov_2a4g80rn2i.b[1][1]++,Math.floor(Date.now()/1000));cov_2a4g80rn2i.s[24]++;this._expiryTime=this._timestamp+expirationWindow;}/*eslint complexity: ["error", 12]*/validate(publicKey,allowedOffset,allowNoExpiry){cov_2a4g80rn2i.f[4]++;var err=(cov_2a4g80rn2i.s[25]++,null);cov_2a4g80rn2i.s[26]++;if((cov_2a4g80rn2i.b[3][0]++,!this._unsignedToken)||(cov_2a4g80rn2i.b[3][1]++,!this._signature)){cov_2a4g80rn2i.b[2][0]++;cov_2a4g80rn2i.s[27]++;err=new Error('Token:validate: token='+this._unsignedToken+' : missing data/signature component');cov_2a4g80rn2i.s[28]++;winston.error(err);cov_2a4g80rn2i.s[29]++;return false;}else{cov_2a4g80rn2i.b[2][1]++;}cov_2a4g80rn2i.s[30]++;if(!publicKey){cov_2a4g80rn2i.b[4][0]++;cov_2a4g80rn2i.s[31]++;err=new Error('Token:validate: token='+this._unsignedToken+' : No public key provided');cov_2a4g80rn2i.s[32]++;winston.error(err);cov_2a4g80rn2i.s[33]++;return false;}else{cov_2a4g80rn2i.b[4][1]++;}var now=(cov_2a4g80rn2i.s[34]++,Math.floor(Date.now()/1000));/* make sure the token does not have a timestamp in the future
     * we'll allow the configured offset between servers */cov_2a4g80rn2i.s[35]++;if((cov_2a4g80rn2i.b[6][0]++,this._timestamp!==0)&&(cov_2a4g80rn2i.b[6][1]++,this._timestamp-allowedOffset>now)){cov_2a4g80rn2i.b[5][0]++;cov_2a4g80rn2i.s[36]++;err=new Error('Token:validate: token='+this._unsignedToken+' : has future timestamp='+this._timestamp+' : current time='+now+' : allowed offset='+allowedOffset);cov_2a4g80rn2i.s[37]++;winston.error(err);cov_2a4g80rn2i.s[38]++;return false;}else{cov_2a4g80rn2i.b[5][1]++;}/* make sure we don't have unlimited tokens unless we have
     * explicitly enabled that option for our system. by default
     * they should have an expiration date of less than 30 days */cov_2a4g80rn2i.s[39]++;if((cov_2a4g80rn2i.b[8][0]++,this._expiryTime!==0)||(cov_2a4g80rn2i.b[8][1]++,!ATHENZ_TOKEN_NO_EXPIRY)||(cov_2a4g80rn2i.b[8][2]++,!allowNoExpiry)){cov_2a4g80rn2i.b[7][0]++;cov_2a4g80rn2i.s[40]++;if(this._expiryTime<now){cov_2a4g80rn2i.b[9][0]++;cov_2a4g80rn2i.s[41]++;err=new Error('Token:validate: token='+this._unsignedToken+' : has expired time='+this._expiryTime+' : current time='+now);cov_2a4g80rn2i.s[42]++;winston.error(err);cov_2a4g80rn2i.s[43]++;return false;}else{cov_2a4g80rn2i.b[9][1]++;}cov_2a4g80rn2i.s[44]++;if(this._expiryTime>now+ATHENZ_TOKEN_MAX_EXPIRY+allowedOffset){cov_2a4g80rn2i.b[10][0]++;cov_2a4g80rn2i.s[45]++;err=new Error('Token:validate: token='+this._unsignedToken+' : expires too far in the future='+this._expiryTime+' : current time='+now+' : max expiry='+ATHENZ_TOKEN_MAX_EXPIRY+' : allowed offset='+allowedOffset);cov_2a4g80rn2i.s[46]++;winston.error(err);cov_2a4g80rn2i.s[47]++;return false;}else{cov_2a4g80rn2i.b[10][1]++;}}else{cov_2a4g80rn2i.b[7][1]++;}var verified=(cov_2a4g80rn2i.s[48]++,false);//fail safe
cov_2a4g80rn2i.s[49]++;try{cov_2a4g80rn2i.s[50]++;verified=Crypto.verify(this._unsignedToken,publicKey,this._signature,this._digestAlgorithm);cov_2a4g80rn2i.s[51]++;if(verified===false){cov_2a4g80rn2i.b[11][0]++;cov_2a4g80rn2i.s[52]++;err=new Error('Token:validate: token='+this._unsignedToken+' : authentication failed');cov_2a4g80rn2i.s[53]++;winston.error(err);}else{cov_2a4g80rn2i.b[11][1]++;cov_2a4g80rn2i.s[54]++;winston.debug('validate: Token successfully authenticated');}}catch(e){cov_2a4g80rn2i.s[55]++;winston.error('Token:validate: token='+this._unsignedToken+' : verify signature failed due to Exception='+e.message);}cov_2a4g80rn2i.s[56]++;return verified;}getVersion(){cov_2a4g80rn2i.f[5]++;cov_2a4g80rn2i.s[57]++;return this._version;}getSalt(){cov_2a4g80rn2i.f[6]++;cov_2a4g80rn2i.s[58]++;return this._salt;}getHost(){cov_2a4g80rn2i.f[7]++;cov_2a4g80rn2i.s[59]++;return this._host;}getDomain(){cov_2a4g80rn2i.f[8]++;cov_2a4g80rn2i.s[60]++;return this._domain;}getSignature(){cov_2a4g80rn2i.f[9]++;cov_2a4g80rn2i.s[61]++;return this._signature;}getTimestamp(){cov_2a4g80rn2i.f[10]++;cov_2a4g80rn2i.s[62]++;return this._timestamp;}getExpiryTime(){cov_2a4g80rn2i.f[11]++;cov_2a4g80rn2i.s[63]++;return this._expiryTime;}getSignedToken(){cov_2a4g80rn2i.f[12]++;cov_2a4g80rn2i.s[64]++;return this._signedToken;}getKeyId(){cov_2a4g80rn2i.f[13]++;cov_2a4g80rn2i.s[65]++;return this._keyId;}getIP(){cov_2a4g80rn2i.f[14]++;cov_2a4g80rn2i.s[66]++;return this._ip;}getUnsignedToken(){cov_2a4g80rn2i.f[15]++;cov_2a4g80rn2i.s[67]++;return this._unsignedToken;}/**
   * Helper method to parse a credential to remove the signature from the
   * raw credential string. Returning the unsigned credential.
   * @param credential full token credentials including signature
   * @return credentials without the signature
   **/static getUnsignedToken(credential){cov_2a4g80rn2i.f[16]++;cov_2a4g80rn2i.s[68]++;if(credential){cov_2a4g80rn2i.b[12][0]++;var idx=(cov_2a4g80rn2i.s[69]++,credential.indexOf(';s='));cov_2a4g80rn2i.s[70]++;if(idx!==-1){cov_2a4g80rn2i.b[13][0]++;cov_2a4g80rn2i.s[71]++;credential=credential.substring(0,idx);}else{cov_2a4g80rn2i.b[13][1]++;}}else{cov_2a4g80rn2i.b[12][1]++;}cov_2a4g80rn2i.s[72]++;return credential;}}cov_2a4g80rn2i.s[73]++;module.exports=Token;